name: Test E2E Script Execution

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  test:
    name: Test on ${{ matrix.browser }}
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        browser: [chrome, firefox, edge]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Chrome
        if: matrix.browser == 'chrome'
        uses: browser-actions/setup-chrome@v1
        with:
          chrome-version: stable

      - name: Install Firefox
        if: matrix.browser == 'firefox'
        uses: browser-actions/setup-firefox@v1
        with:
          firefox-version: latest

      - name: Install Edge
        if: matrix.browser == 'edge'
        run: |
          curl https://packages.microsoft.com/keys/microsoft.asc | gpg --dearmor > microsoft.gpg
          sudo install -o root -g root -m 644 microsoft.gpg /etc/apt/trusted.gpg.d/
          sudo sh -c 'echo "deb [arch=amd64] https://packages.microsoft.com/repos/edge stable main" > /etc/apt/sources.list.d/microsoft-edge.list'
          sudo apt-get update
          sudo apt-get install -y microsoft-edge-stable

      - name: Verify browser installation
        run: |
          echo "Browser: ${{ matrix.browser }}"
          if [ "${{ matrix.browser }}" = "chrome" ]; then
            google-chrome --version
          elif [ "${{ matrix.browser }}" = "firefox" ]; then
            firefox --version
          elif [ "${{ matrix.browser }}" = "edge" ]; then
            microsoft-edge --version
          fi

      - name: Install Node.js dependencies
        run: npm ci

      - name: Install Python dependencies
        run: pip install -r e2e-tests/requirements.txt

      - name: Run tests for ${{ matrix.browser }}
        run: python e2e-tests/test-browser-script-execution.py ${{ matrix.browser }}

